# åŸºäºå¼ºåŒ–å­¦ä¹ çš„ Petri ç½‘äº¤é€šä¿¡å·æ§åˆ¶

[![Python](https://img.shields.io/badge/Python-3.8+-blue.svg)](https://www.python.org/)
[![License](https://img.shields.io/badge/License-MIT-green.svg)](LICENSE)

## ğŸ“– é¡¹ç›®ç®€ä»‹

æœ¬é¡¹ç›®ä½¿ç”¨**æ·±åº¦å¼ºåŒ–å­¦ä¹ ï¼ˆDQNï¼‰**ç»“åˆ**Petri ç½‘å»ºæ¨¡**æ¥å®ç°æ™ºèƒ½äº¤é€šä¿¡å·ç¯æ§åˆ¶ç³»ç»Ÿã€‚ç³»ç»Ÿé€šè¿‡å¼ºåŒ–å­¦ä¹ ç®—æ³•å­¦ä¹ æœ€ä¼˜çš„ä¿¡å·ç¯åˆ‡æ¢ç­–ç•¥ï¼Œåœ¨æ»¡è¶³ Petri ç½‘å®‰å…¨çº¦æŸçš„å‰æä¸‹ï¼Œæœ€å¤§åŒ–äº¤é€šæµé‡å¹¶æœ€å°åŒ–è½¦è¾†ç­‰å¾…æ—¶é—´ã€‚

### æ ¸å¿ƒç‰¹ç‚¹

- ğŸš¦ **Petri ç½‘çº¦æŸå»ºæ¨¡**ï¼šä½¿ç”¨ Petri ç½‘ç²¾ç¡®æè¿°äº¤é€šè·¯å£çš„ä¿¡å·ç¯çŠ¶æ€è½¬æ¢è§„åˆ™å’Œå®‰å…¨çº¦æŸ
- ğŸ¤– **çº¦æŸæ„ŸçŸ¥çš„ DQN**ï¼šå®ç°äº†å¸¦çº¦æŸçš„æ·±åº¦ Q ç½‘ç»œï¼ˆCDQNï¼‰ï¼Œç¡®ä¿æ™ºèƒ½ä½“åªé€‰æ‹©åˆæ³•çš„ä¿¡å·ç¯åˆ‡æ¢åŠ¨ä½œ
- ğŸš— **çœŸå®äº¤é€šä»¿çœŸ**ï¼šåŸºäºæ³Šæ¾åˆ†å¸ƒçš„è½¦è¾†åˆ°è¾¾å’Œç¦»å¼€æ¨¡å‹ï¼Œæ¨¡æ‹ŸçœŸå®äº¤é€šæµ
- ğŸ“Š **å¤šæŒ‡æ ‡è¯„ä¼°**ï¼šæ”¯æŒç­‰å¾…æ—¶é—´ã€çº¦æŸè¿åç‡ã€é€šè¡Œè½¦è¾†æ•°ç­‰å¤šç»´åº¦æ€§èƒ½è¯„ä¼°

## ğŸ¯ é¡¹ç›®ä½œç”¨

**ç”¨ä¸€å¥è¯æ¦‚æ‹¬**ï¼šåœ¨ Petri ç½‘å»ºæ¨¡çš„äº¤é€šè·¯å£çº¦æŸä¸‹ï¼Œè®­ç»ƒä¸€ä¸ªå¼ºåŒ–å­¦ä¹ æ™ºèƒ½ä½“ï¼Œè®©å®ƒè‡ªåŠ¨æ§åˆ¶çº¢ç»¿ç¯ï¼Œä½¿å¾—è½¦æµæ›´é€šç•…ã€ç­‰å¾…æ—¶é—´æ›´çŸ­ã€ä¸”ä¸è¿åå®‰å…¨è§„åˆ™ã€‚

### åº”ç”¨åœºæ™¯

- æ™ºèƒ½äº¤é€šä¿¡å·ç¯æ§åˆ¶ç³»ç»Ÿ
- äº¤é€šæµé‡ä¼˜åŒ–ç ”ç©¶
- çº¦æŸå¼ºåŒ–å­¦ä¹ ç®—æ³•éªŒè¯
- Petri ç½‘ä¸å¼ºåŒ–å­¦ä¹ ç»“åˆçš„åº”ç”¨ç ”ç©¶

### ğŸ“ å¿«é€Ÿå¯¼èˆªï¼šå…³é”®æŠ€æœ¯å®ç°ä½ç½®

| æŠ€æœ¯ | æ ¸å¿ƒæ–‡ä»¶ | å…³é”®æ–¹æ³•/è¡Œæ•° |
|------|---------|--------------|
| **SE-MDP** | `environment/petri_net.py` | `_get_obs()` (237-250è¡Œ) |
| **PN-CDQN** | `agents/constrained_dqn.py` | `act()` (35-42è¡Œ), `_update()` (80-91è¡Œ) |
| **å®‰å…¨åŒ…è£…å™¨** | `environment/petri_net.py` | `_do_action()` (206-220è¡Œ) |

è¯¦ç»†è¯´æ˜è¯·æŸ¥çœ‹ä¸‹æ–¹çš„ **[ä¸‰å¤§æ ¸å¿ƒæŠ€æœ¯](#-ä¸‰å¤§æ ¸å¿ƒæŠ€æœ¯)** éƒ¨åˆ†ã€‚

## ğŸ—ï¸ é¡¹ç›®æ¶æ„

### æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     è®­ç»ƒ/è¯„ä¼°è„šæœ¬å±‚                           â”‚
â”‚  train.py | baseline.py | evaluation.py | simulation.py    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   æ™ºèƒ½ä½“å±‚ (Agents)                          â”‚
â”‚  DQN / CDQN (çº¦æŸæ„ŸçŸ¥çš„æ·±åº¦ Q ç½‘ç»œ)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ç¯å¢ƒå±‚ (Environment)                       â”‚
â”‚  JunctionPetriNetEnv: Gym å…¼å®¹çš„å¼ºåŒ–å­¦ä¹ ç¯å¢ƒ                 â”‚
â”‚  - Petri ç½‘çŠ¶æ€ç®¡ç†                                          â”‚
â”‚  - è½¦è¾†åˆ°è¾¾/ç¦»å¼€ä»¿çœŸ                                         â”‚
â”‚  - å¥–åŠ±å‡½æ•°è®¡ç®—                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Petri ç½‘è§£æå±‚ (Utils)                      â”‚
â”‚  parser_pnpro.py | parser_pnml.py | entities.py            â”‚
â”‚  å°† PNPRO/PNML æ–‡ä»¶è§£æä¸ºå¯æ“ä½œçš„ Petri ç½‘å¯¹è±¡              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     æ•°æ®å±‚ (Data)                            â”‚
â”‚  traffic-scenario.PNPRO (äº¤é€šåœºæ™¯ Petri ç½‘æ¨¡å‹)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
PNPRO æ–‡ä»¶å®šä¹‰è·¯å£ä¿¡å·ç¯çš„ Petri ç½‘è§„åˆ™
Parser æŠŠæ–‡ä»¶è§£ææˆ Place/Transition/Arc
convert_to_snakes() å˜æˆâ€œå¯è¿è¡Œâ€çš„ Petri ç½‘å¯¹è±¡ï¼ˆèƒ½ç®— modesã€èƒ½ fireï¼‰
ç¯å¢ƒæ¯ä¸€æ­¥ï¼š
ç”¨ Petri ç½‘åˆ¤æ–­åŠ¨ä½œæ˜¯å¦åˆæ³•ã€æ‰§è¡Œ token æµåŠ¨ï¼ˆfireï¼‰
æ ¹æ®å½“å‰ token åˆ†å¸ƒæ¨å¯¼â€œç°åœ¨å“ªäº›åŠ¨ä½œå¯é€‰â€ï¼ˆmodesï¼‰å¹¶å†™è¿›è§‚æµ‹
æ™ºèƒ½ä½“çœ‹åˆ°è¿™äº›ä¿¡æ¯ï¼Œåªåœ¨åˆæ³•åŠ¨ä½œé‡Œé€‰ï¼ˆPN-CDQNï¼‰
### æ ¸å¿ƒæ¨¡å—è¯´æ˜

#### 1. **ç¯å¢ƒæ¨¡å—** (`environment/`)
- `petri_net.py`: æ ¸å¿ƒç¯å¢ƒç±» `JunctionPetriNetEnv`
  - å®ç° Gymnasium æ¥å£ï¼Œæä¾›æ ‡å‡†çš„å¼ºåŒ–å­¦ä¹ ç¯å¢ƒ
  - ç®¡ç† Petri ç½‘çŠ¶æ€å’Œè½¦è¾†é˜Ÿåˆ—
  - å¤„ç†åŠ¨ä½œæ‰§è¡Œå’Œå¥–åŠ±è®¡ç®—
- `petri_net_array.py`: å‘é‡åŒ–è§‚æµ‹ç©ºé—´ç‰ˆæœ¬ï¼ˆç”¨äºæŸäº›ç®—æ³•ï¼‰

#### 2. **æ™ºèƒ½ä½“æ¨¡å—** (`agents/`)
- `dqn.py`: DQN æ™ºèƒ½ä½“æ„å»ºå‡½æ•°
- `constrained_dqn.py`: **çº¦æŸæ„ŸçŸ¥çš„ DQN (CDQN)**
  - åœ¨åŠ¨ä½œé€‰æ‹©æ—¶è¿‡æ»¤æ‰ Petri ç½‘çº¦æŸä¸å…è®¸çš„åŠ¨ä½œ
  - ç¡®ä¿æ™ºèƒ½ä½“åªå­¦ä¹ åˆæ³•çš„ä¿¡å·ç¯åˆ‡æ¢ç­–ç•¥

#### 3. **Petri ç½‘å·¥å…·** (`utils/petri_net/`)
- `parser_pnpro.py`: è§£æ PNPRO æ ¼å¼æ–‡ä»¶
- `parser_pnml.py`: è§£æ PNML æ ¼å¼æ–‡ä»¶
- `entities.py`: Petri ç½‘åŸºæœ¬å…ƒç´ å®šä¹‰ï¼ˆPlaceã€Transitionã€Arcï¼‰

#### 4. **å¥–åŠ±å‡½æ•°** (`rewards/`)
- æä¾›å¤šç§å¥–åŠ±å‡½æ•°ï¼Œå¦‚ `base_reward`ã€`discounted_reward` ç­‰
- å¯æ ¹æ®ä¸åŒä¼˜åŒ–ç›®æ ‡è‡ªå®šä¹‰å¥–åŠ±å‡½æ•°

## ğŸ“ ç›®å½•ç»“æ„

```
reinforcementLearningPetriNets/
â”œâ”€â”€ agents/                      # æ™ºèƒ½ä½“æ¨¡å—
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ dqn.py                   # DQN æ™ºèƒ½ä½“æ„å»º
â”‚   â”œâ”€â”€ constrained_dqn.py       # çº¦æŸæ„ŸçŸ¥ DQN
â”‚   â”œâ”€â”€ constrained_model.py
â”‚   â””â”€â”€ constrained_policy.py
â”œâ”€â”€ environment/                 # ç¯å¢ƒæ¨¡å—
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ petri_net.py             # æ ¸å¿ƒäº¤é€šç¯å¢ƒ
â”‚   â””â”€â”€ petri_net_array.py       # å‘é‡åŒ–è§‚æµ‹ç‰ˆæœ¬
â”œâ”€â”€ utils/                       # å·¥å…·æ¨¡å—
â”‚   â””â”€â”€ petri_net/
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ entities.py          # Petri ç½‘å®ä½“å®šä¹‰
â”‚       â”œâ”€â”€ parser_base.py       # è§£æå™¨åŸºç±»
â”‚       â”œâ”€â”€ parser_pnml.py       # PNML è§£æå™¨
â”‚       â””â”€â”€ parser_pnpro.py      # PNPRO è§£æå™¨
â”œâ”€â”€ rewards/                     # å¥–åŠ±å‡½æ•°
â”‚   â””â”€â”€ __init__.py
â”œâ”€â”€ data/                        # æ•°æ®æ–‡ä»¶
â”‚   â””â”€â”€ traffic-scenario.PNPRO   # äº¤é€šåœºæ™¯ Petri ç½‘æ¨¡å‹
â”œâ”€â”€ plotting/                    # å¯è§†åŒ–å·¥å…·
â”‚   â”œâ”€â”€ generate_plot_from_data.py
â”‚   â””â”€â”€ generate_plot.ipynb
â”œâ”€â”€ slurm/                       # é›†ç¾¤è®­ç»ƒè„šæœ¬
â”‚   â”œâ”€â”€ start_all.sh
â”‚   â””â”€â”€ train_single.sh
â”œâ”€â”€ train.py                     # ä¸»è®­ç»ƒè„šæœ¬
â”œâ”€â”€ baseline.py                  # åŸºçº¿ç­–ç•¥æµ‹è¯•
â”œâ”€â”€ evaluation.py                # è¯„ä¼°è„šæœ¬
â”œâ”€â”€ simulation.py                # ä»¿çœŸè„šæœ¬
â”œâ”€â”€ requirements.txt             # ä¾èµ–åŒ…åˆ—è¡¨
â””â”€â”€ README.md                    # é¡¹ç›®æ–‡æ¡£
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚

- Python 3.8+
- PyTorch
- CUDA (å¯é€‰ï¼Œç”¨äº GPU åŠ é€Ÿ)

### å®‰è£…æ­¥éª¤

1. **å…‹éš†é¡¹ç›®**
```bash
git clone <repository-url>
cd reinforcementLearningPetriNets
```

2. **å®‰è£…ä¾èµ–**
```bash
pip install -r requirements.txt
```

ä¸»è¦ä¾èµ–åŒ…ï¼š
- `gymnasium`: å¼ºåŒ–å­¦ä¹ ç¯å¢ƒæ¥å£
- `skrl`: å¼ºåŒ–å­¦ä¹ ç®—æ³•åº“
- `snakes`: Petri ç½‘åº“
- `numpy`: æ•°å€¼è®¡ç®—
- `beautifulsoup4`, `lxml`: XML è§£æï¼ˆç”¨äºè§£æ Petri ç½‘æ–‡ä»¶ï¼‰

### åŸºæœ¬ä½¿ç”¨

#### 1. è®­ç»ƒæ™ºèƒ½ä½“

```bash
python train.py --train --batch-size 64 --exploration-timesteps 600000
```

å‚æ•°è¯´æ˜ï¼š
- `--train`: å¯ç”¨è®­ç»ƒæ¨¡å¼
- `--batch-size`: æ‰¹æ¬¡å¤§å°
- `--exploration-timesteps`: æ¢ç´¢æ­¥æ•°
- `--exploration-final-epsilon`: æœ€ç»ˆæ¢ç´¢ç‡ï¼ˆé»˜è®¤ 0.04ï¼‰
- `--learning-starts`: å¼€å§‹å­¦ä¹ çš„æ­¥æ•°ï¼ˆé»˜è®¤ 20000ï¼‰
- `--random-timesteps`: éšæœºæ¢ç´¢æ­¥æ•°ï¼ˆé»˜è®¤ 10000ï¼‰

#### 2. è¯„ä¼°å·²è®­ç»ƒæ¨¡å‹

```bash
python train.py --eval --path <æ¨¡å‹è·¯å¾„>
```

æˆ–ä½¿ç”¨ä¸“ç”¨è¯„ä¼°è„šæœ¬ï¼š
```bash
python evaluation.py --path <æ¨¡å‹è·¯å¾„>
```

#### 3. è¿è¡ŒåŸºçº¿ç­–ç•¥

```bash
python baseline.py
```

åŸºçº¿ç­–ç•¥ä¼šä½¿ç”¨å›ºå®šçš„åŠ¨ä½œåºåˆ—æˆ–éšæœºç­–ç•¥ï¼Œç”¨äºå¯¹æ¯”å¼ºåŒ–å­¦ä¹ ç­–ç•¥çš„æ•ˆæœã€‚

#### 4. æ‰¹é‡ä»¿çœŸè¯„ä¼°

```bash
python simulation.py
```

è¯¥è„šæœ¬ä¼šåŠ è½½å¤šä¸ªè®­ç»ƒå¥½çš„æ¨¡å‹ï¼Œè¿›è¡Œæ‰¹é‡è¯„ä¼°å¹¶ç”Ÿæˆç»“æœ CSV æ–‡ä»¶ã€‚

## ğŸ”‘ ä¸‰å¤§æ ¸å¿ƒæŠ€æœ¯

æœ¬é¡¹ç›®å®ç°äº†ä¸‰ä¸ªå…³é”®æŠ€æœ¯ï¼Œå°† Petri ç½‘çº¦æŸä¸å¼ºåŒ–å­¦ä¹ æ·±åº¦èåˆï¼š

### å…³é”®æŠ€æœ¯ 1ï¼šSE-MDPï¼ˆçŠ¶æ€å¢å¼ºçš„é©¬å°”å¯å¤«å†³ç­–è¿‡ç¨‹ï¼‰

**æ ¸å¿ƒæ€æƒ³**ï¼šå°†ä¼ ç»Ÿ RL çš„å¤–éƒ¨è§‚å¯Ÿä¸ Petri ç½‘å†…éƒ¨çŠ¶æ€èåˆï¼Œå½¢æˆå¢å¼ºçŠ¶æ€ç©ºé—´ã€‚

**ä¼ ç»Ÿ RL çŠ¶æ€**ï¼š
```
s = "è·¯ä¸Šæœ‰5è¾†è½¦"  # ä»…å¤–éƒ¨è§‚å¯Ÿ
```

**SE-MDP å¢å¼ºçŠ¶æ€**ï¼š
```
s' = (s, x)
å…¶ä¸­ï¼š
- s: å¤–éƒ¨è§‚å¯Ÿï¼ˆè·¯ä¸Šæœ‰5è¾†è½¦ã€ç­‰å¾…æ—¶é—´ç­‰ï¼‰
- x: Petri ç½‘å†…éƒ¨çŠ¶æ€ï¼ˆå½“å‰tokenåœ¨"å—åŒ—çº¢ç¯"ä½ç½®ã€å“ªäº›å˜è¿å¯ç”¨ç­‰ï¼‰
```

**å®ç°ä½ç½®**ï¼š
- **çŠ¶æ€æ„å»º**ï¼š`environment/petri_net.py` çš„ `_get_obs()` æ–¹æ³•ï¼ˆç¬¬237-250è¡Œï¼‰
  ```python
  # å¤–éƒ¨è§‚å¯Ÿï¼šè½¦è¾†æ•°å’Œç­‰å¾…æ—¶é—´
  obs["vehicle_obs-{}-n".format(lane.name)] = np.array([len(lane.vehicles)])
  obs["vehicle_obs-{}-t".format(lane.name)] = np.array([lane.max_time()])
  
  # Petriç½‘å†…éƒ¨çŠ¶æ€ï¼šå˜è¿å¯ç”¨æ€§
  obs["act-{}".format(t.name)] = np.array(1.0 if len(t.modes()) > 0 else 0.0)
  
  # Petriç½‘å†…éƒ¨çŠ¶æ€ï¼šåº“æ‰€tokenæ•°ï¼ˆå¯é€‰ï¼‰
  obs["net-{}".format(place.name)] = np.array([len(place.tokens)])
  ```

**ä¼˜åŠ¿**ï¼š
- âœ… æ™ºèƒ½ä½“èƒ½å¤Ÿ"çœ‹åˆ°"Petri ç½‘çš„å†…éƒ¨çŠ¶æ€ï¼ŒçŸ¥é“å“ªäº›åŠ¨ä½œå½“å‰å¯ç”¨
- âœ… çŠ¶æ€ç©ºé—´åŒ…å«å®Œæ•´çš„çº¦æŸä¿¡æ¯ï¼Œä¾¿äºåç»­çš„åŠ¨ä½œè¿‡æ»¤
- âœ… ç¬¦åˆé©¬å°”å¯å¤«æ€§è´¨ï¼ŒçŠ¶æ€åŒ…å«å†³ç­–æ‰€éœ€çš„æ‰€æœ‰ä¿¡æ¯

---

### å…³é”®æŠ€æœ¯ 2ï¼šPN-CDQNï¼ˆPetri ç½‘çº¦æŸçš„ DQNï¼‰

**æ ¸å¿ƒæ€æƒ³**ï¼šä¿®æ”¹ DQN çš„æ ¸å¿ƒæ›´æ–°å…¬å¼ï¼Œ**åªä» Petri ç½‘å…è®¸çš„åˆæ³•åŠ¨ä½œä¸­é€‰æ‹©æœ€ä¼˜åŠ¨ä½œ**ã€‚

**åŸ DQN æ›´æ–°å…¬å¼**ï¼š
```python
# ä»æ‰€æœ‰åŠ¨ä½œä¸­é€‰ä»·å€¼æœ€å¤§çš„
action = argmax(Q(s, a))  # å¯èƒ½é€‰åˆ°éæ³•åŠ¨ä½œï¼
```

**PN-CDQN æ›´æ–°å…¬å¼**ï¼š
```python
# åªä»Petriç½‘å…è®¸çš„åˆæ³•åŠ¨ä½œä¸­é€‰
valid_actions = PetriNet.get_valid_transitions(s)  # è·å–åˆæ³•åŠ¨ä½œé›†åˆ
action = argmax(Q(s, a) for a in valid_actions)  # åªåœ¨åˆæ³•åŠ¨ä½œä¸­é€‰
```

**å®ç°ä½ç½®**ï¼š

1. **åŠ¨ä½œé€‰æ‹©ï¼ˆè¯„ä¼°æ¨¡å¼ï¼‰**ï¼š`agents/constrained_dqn.py` çš„ `act()` æ–¹æ³•ï¼ˆç¬¬35-42è¡Œï¼‰
   ```python
   # æå–Petriç½‘å˜è¿å¯ç”¨æ€§ï¼ˆå‰Nç»´ï¼‰
   transitions = states.numpy()[0][:self.action_space.n]
   
   # è®¡ç®—æ‰€æœ‰åŠ¨ä½œçš„Qå€¼
   q_actions = self.q_network.act({"states": states}, role="q_network")[0]
   
   # è¿‡æ»¤ï¼šåªä¿ç•™åˆæ³•åŠ¨ä½œçš„Qå€¼
   valid_q_actions = torch.mul(q_actions, torch.Tensor(transitions))
   
   # åªåœ¨åˆæ³•åŠ¨ä½œä¸­é€‰æ‹©æœ€ä¼˜åŠ¨ä½œ
   return torch.argmax(valid_q_actions, dim=1, keepdim=True)
   ```

2. **Qå€¼æ›´æ–°**ï¼š`agents/constrained_dqn.py` çš„ `_update()` æ–¹æ³•ï¼ˆç¬¬80-91è¡Œï¼‰
   ```python
   # æå–ä¸‹ä¸€ä¸ªçŠ¶æ€çš„åˆæ³•åŠ¨ä½œé›†åˆ
   transitions = sampled_states[:,:self.action_space.n]
   
   # è®¡ç®—ä¸‹ä¸€ä¸ªçŠ¶æ€çš„Qå€¼
   next_q_values = self.target_q_network.act({"states": sampled_next_states})
   
   # è¿‡æ»¤ï¼šåªè€ƒè™‘åˆæ³•åŠ¨ä½œçš„Qå€¼
   next_valid_q_values = torch.mul(next_q_values, transitions)
   
   # è®¡ç®—ç›®æ ‡Qå€¼ï¼ˆåªåœ¨åˆæ³•åŠ¨ä½œä¸­å–æœ€å¤§å€¼ï¼‰
   target_q_values = torch.max(next_valid_q_values, dim=-1, keepdim=True)[0]
   ```

3. **éšæœºåŠ¨ä½œé€‰æ‹©**ï¼š`agents/constrained_dqn.py` çš„ `random_act()` æ–¹æ³•ï¼ˆç¬¬139-142è¡Œï¼‰
   ```python
   # åªåœ¨åˆæ³•åŠ¨ä½œä¸­éšæœºé€‰æ‹©
   transitions = inputs["states"].numpy()[0][:self.action_space.n]
   valid_transitions = np.where(transitions == 1)[0]
   chosen_random_action = random.choice(valid_transitions)
   ```

4. **æ¨¡å‹å±‚çº¦æŸ**ï¼š`agents/constrained_model.py` çš„ `c_deterministic_model`ï¼ˆç¬¬56è¡Œï¼‰
   ```python
   # åœ¨æ¨¡å‹è¾“å‡ºæ—¶ç›´æ¥åº”ç”¨çº¦æŸæ©ç 
   return torch.mul(output, inputs["states"][0][0:self.action_space.n])
   ```

**ä¼˜åŠ¿**ï¼š
- âœ… **å®‰å…¨æ€§ä¿è¯**ï¼šæ™ºèƒ½ä½“æ°¸è¿œä¸ä¼šé€‰æ‹©è¿å Petri ç½‘çº¦æŸçš„åŠ¨ä½œ
- âœ… **å­¦ä¹ æ•ˆç‡é«˜**ï¼šä¸éœ€è¦æµªè´¹æ¢ç´¢æ­¥æ•°åœ¨æ— æ•ˆåŠ¨ä½œä¸Š
- âœ… **ç†è®ºä¿è¯**ï¼šç›¸å½“äºåœ¨"äº¤é€šæ³•è§„æ‰‹å†Œ"å…è®¸çš„ç­”æ¡ˆä¸­é€‰æ‹©æœ€ä¼˜è§£

---

### å…³é”®æŠ€æœ¯ 3ï¼šé€šç”¨å®‰å…¨åŒ…è£…å™¨ï¼ˆç¯å¢ƒå±‚çº¦æŸæ£€æŸ¥ï¼‰

**æ ¸å¿ƒæ€æƒ³**ï¼šåœ¨ç¯å¢ƒå±‚é¢è®¾ç½®"å®‰å…¨å£³"ï¼Œè‡ªåŠ¨æ‹¦æˆªéæ³•åŠ¨ä½œå¹¶è¿”å›å¤±è´¥ä¿¡å·ã€‚

**å®ç°ä½ç½®**ï¼š`environment/petri_net.py` çš„ `_do_action()` æ–¹æ³•ï¼ˆç¬¬206-220è¡Œï¼‰

```python
def _do_action(self, action) -> bool:
    action = self.actions_to_transitions[action]
    if action in [t.name for t in self.net.transition()]:
        # æ£€æŸ¥Petriç½‘å˜è¿æ˜¯å¦å¯è§¦å‘
        if len(self.net.transition(action).modes()) > 0:
            # åˆæ³•åŠ¨ä½œï¼šæ‰§è¡ŒPetriç½‘å˜è¿
            self.net.transition(action).fire(self.net.transition(action).modes()[0])
        else:
            # éæ³•åŠ¨ä½œï¼šPetriç½‘çº¦æŸé™åˆ¶ï¼Œè¿”å›å¤±è´¥
            return False  # çº¦æŸè¿åï¼
    elif action == "None":
        return True
    else:
        return False
```

**å·¥ä½œæµç¨‹**ï¼š
1. æ™ºèƒ½ä½“é€‰æ‹©åŠ¨ä½œ â†’ ç¯å¢ƒæ¥æ”¶åŠ¨ä½œ
2. ç¯å¢ƒæ£€æŸ¥ Petri ç½‘çº¦æŸ â†’ åŠ¨ä½œæ˜¯å¦å¯è§¦å‘ï¼Ÿ
3. **å¦‚æœåˆæ³•**ï¼šæ‰§è¡ŒåŠ¨ä½œï¼Œè¿”å› `success=True`
4. **å¦‚æœéæ³•**ï¼šæ‹’ç»æ‰§è¡Œï¼Œè¿”å› `success=False`ï¼ˆåœ¨ `info` ä¸­è®°å½•ï¼‰

**ä¼˜åŠ¿**ï¼š
- âœ… **é€šç”¨æ€§**ï¼šä»»ä½• RL ç®—æ³•ï¼ˆä¸åªæ˜¯ DQNï¼‰éƒ½èƒ½ä½¿ç”¨ï¼Œæ— éœ€ä¿®æ”¹ç®—æ³•ä»£ç 
- âœ… **åŒé‡ä¿æŠ¤**ï¼šå³ä½¿æ™ºèƒ½ä½“é€‰æ‹©äº†éæ³•åŠ¨ä½œï¼Œç¯å¢ƒä¹Ÿä¼šæ‹¦æˆª
- âœ… **å¯è§‚æµ‹æ€§**ï¼šé€šè¿‡ `info["success"]` å¯ä»¥ç»Ÿè®¡çº¦æŸè¿åæ¬¡æ•°

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```python
obs, reward, terminated, truncated, info = env.step(action)
if not info["success"]:
    print("çº¦æŸè¿åï¼åŠ¨ä½œè¢«æ‹’ç»")
```

---

### âš ï¸ é‡è¦ï¼šä¸ºä»€ä¹ˆç¯å¢ƒä¸"è‡ªåŠ¨æ”¹æˆåˆæ³•åŠ¨ä½œ"ï¼Ÿ

**æ ¸å¿ƒé—®é¢˜**ï¼šå½“æ™®é€š DQN é€‰æ‹©äº†éæ³•åŠ¨ä½œï¼ˆæ¯”å¦‚æƒ³åŒæ—¶è®©ä¸¤ä¸ªæ–¹å‘å…¨ç»¿ï¼‰ï¼Œä¸ºä»€ä¹ˆç¯å¢ƒä¸"è‡ªåŠ¨æ”¹æˆæœ€è¿‘çš„åˆæ³•åŠ¨ä½œ"ï¼Ÿ

**ç­”æ¡ˆï¼šç¯å¢ƒä¸çŸ¥é“"æ”¹æˆå“ªä¸ªåˆæ³•åŠ¨ä½œ"æ˜¯åˆç†çš„ï¼**

#### åœºæ™¯ç¤ºä¾‹

å‡è®¾å½“å‰çŠ¶æ€ï¼š
- åˆæ³•åŠ¨ä½œé›†åˆ = `[åŠ¨ä½œA: å—åŒ—ç»¿ç¯, åŠ¨ä½œB: ä¸œè¥¿ç»¿ç¯, åŠ¨ä½œC: ä»€ä¹ˆéƒ½ä¸åš]`
- æ™®é€š DQN é€‰æ‹©äº†ï¼š`åŠ¨ä½œX: åŒæ—¶å—åŒ—+ä¸œè¥¿å…¨ç»¿`ï¼ˆéæ³•ï¼ï¼‰

**ç¯å¢ƒé¢ä¸´çš„é€‰æ‹©å›°å¢ƒ**ï¼š
1. æ”¹æˆ `åŠ¨ä½œA`ï¼Ÿä½†å¯èƒ½ `åŠ¨ä½œB` æ›´åˆç†ï¼ˆä¸œè¥¿æ–¹å‘è½¦æ›´å¤šï¼‰
2. æ”¹æˆ `åŠ¨ä½œB`ï¼Ÿä½†å¯èƒ½ `åŠ¨ä½œA` æ›´åˆç†ï¼ˆå—åŒ—æ–¹å‘ç­‰å¾—æ›´ä¹…ï¼‰
3. æ”¹æˆ `åŠ¨ä½œC`ï¼Ÿä½†å¯èƒ½ä»€ä¹ˆéƒ½ä¸åšä¸æ˜¯æœ€ä¼˜ç­–ç•¥

**ç¯å¢ƒæ— æ³•çŸ¥é“æ™ºèƒ½ä½“çš„"çœŸå®æ„å›¾"**ï¼š
- æ™ºèƒ½ä½“é€‰ `åŠ¨ä½œX` å¯èƒ½æ˜¯å› ä¸ºï¼š
  - å®ƒè®¤ä¸º"åŒæ—¶å…¨ç»¿"èƒ½æœ€å¤§åŒ–é€šè¡Œæ•ˆç‡ï¼ˆè™½ç„¶ç‰©ç†ä¸Šä¸å¯èƒ½ï¼‰
  - å®ƒè¿˜æ²¡å­¦ä¼š Petri ç½‘è§„åˆ™ï¼Œåªæ˜¯éšæœºæ¢ç´¢
  - å®ƒçš„ Q ç½‘ç»œå‚æ•°è¿˜æ²¡è®­ç»ƒå¥½ï¼Œè¾“å‡ºé”™è¯¯

**ç¯å¢ƒçš„èŒè´£**ï¼š
- âœ… **èƒ½åšçš„**ï¼šæ£€æŸ¥åŠ¨ä½œæ˜¯å¦åˆæ³•ï¼Œæ‹’ç»éæ³•åŠ¨ä½œï¼Œè¿”å› `success=False`
- âŒ **ä¸èƒ½åšçš„**ï¼šæ›¿æ™ºèƒ½ä½“"çŒœæµ‹"åº”è¯¥æ”¹æˆå“ªä¸ªåˆæ³•åŠ¨ä½œï¼ˆè¿™éœ€è¦ç­–ç•¥çŸ¥è¯†ï¼‰

#### å¯¹æ¯”ï¼šçº¦æŸç‰ˆ DQN vs æ™®é€š DQN

| ç‰¹æ€§ | **çº¦æŸç‰ˆ DQN (CDQN)** | **æ™®é€š DQN** |
|------|----------------------|-------------|
| **åŠ¨ä½œé€‰æ‹©æ—¶æœº** | **é€‰åŠ¨ä½œä¹‹å‰**å°±è¿‡æ»¤æ‰éæ³•åŠ¨ä½œ | **é€‰åŠ¨ä½œä¹‹å**æ‰çŸ¥é“æ˜¯å¦éæ³• |
| **åŠ¨ä½œé€‰æ‹©é€»è¾‘** | `argmax(Qå€¼ Ã— æ©ç )`ï¼Œåªåœ¨åˆæ³•åŠ¨ä½œä¸­é€‰ | `argmax(Qå€¼)`ï¼Œå¯èƒ½é€‰åˆ°éæ³•åŠ¨ä½œ |
| **ç¯å¢ƒå¤„ç†** | æ°¸è¿œä¸ä¼šæ”¶åˆ°éæ³•åŠ¨ä½œï¼Œ`success` å§‹ç»ˆä¸º `True` | æ”¶åˆ°éæ³•åŠ¨ä½œï¼Œç¯å¢ƒæ‹’ç»ï¼Œ`success=False` |
| **å­¦ä¹ æ•ˆç‡** | âœ… é«˜ï¼šä¸æµªè´¹æ­¥æ•°åœ¨æ— æ•ˆåŠ¨ä½œä¸Š | âŒ ä½ï¼šéœ€è¦å¤§é‡è¯•é”™æ‰èƒ½å­¦ä¼šé¿å¼€éæ³•åŠ¨ä½œ |
| **ä»£ç ä½ç½®** | `agents/constrained_dqn.py::act()` | æ ‡å‡† DQNï¼ˆå¦‚ `skrl.agents.torch.dqn.DQN`ï¼‰ |

#### ä»£ç å¯¹æ¯”

**çº¦æŸç‰ˆ DQNï¼ˆé€‰åŠ¨ä½œå‰è¿‡æ»¤ï¼‰**ï¼š
```python
# agents/constrained_dqn.py::act()
transitions = states.numpy()[0][:self.action_space.n]  # æå–æ©ç 
q_actions = self.q_network.act({"states": states})[0]  # è®¡ç®—Qå€¼
valid_q_actions = torch.mul(q_actions, torch.Tensor(transitions))  # æ©ç è¿‡æ»¤
action = torch.argmax(valid_q_actions)  # åªåœ¨åˆæ³•åŠ¨ä½œä¸­é€‰æœ€å¤§å€¼
# â†’ ç¯å¢ƒæ°¸è¿œä¸ä¼šæ”¶åˆ°éæ³•åŠ¨ä½œï¼
```

**æ™®é€š DQNï¼ˆé€‰åŠ¨ä½œåæ‰çŸ¥é“éæ³•ï¼‰**ï¼š
```python
# æ ‡å‡† DQNï¼ˆä¼ªä»£ç ï¼‰
q_actions = self.q_network.act({"states": states})[0]  # è®¡ç®—Qå€¼
action = torch.argmax(q_actions)  # å¯èƒ½é€‰åˆ°éæ³•åŠ¨ä½œï¼
# â†’ ç¯å¢ƒæ”¶åˆ°éæ³•åŠ¨ä½œï¼Œåªèƒ½æ‹’ç»ï¼š
# environment/petri_net.py::_do_action()
if len(self.net.transition(action).modes()) > 0:
    self.net.transition(action).fire(...)  # åˆæ³•ï¼šæ‰§è¡Œ
else:
    return False  # éæ³•ï¼šæ‹’ç»ï¼Œä½†ä¸çŸ¥é“"åº”è¯¥æ”¹æˆå“ªä¸ª"
```

#### æ€»ç»“

- **çº¦æŸç‰ˆ DQN**ï¼šåœ¨"å†³ç­–é˜¶æ®µ"å°±è¿‡æ»¤ï¼Œ**ä»è®¾è®¡ä¸Šä¿è¯åªé€‰åˆæ³•åŠ¨ä½œ**
- **æ™®é€š DQN**ï¼šåœ¨"æ‰§è¡Œé˜¶æ®µ"æ‰çŸ¥é“éæ³•ï¼Œ**ç¯å¢ƒåªèƒ½æ‹’ç»ï¼Œä¸èƒ½"è‡ªåŠ¨ä¿®æ­£"**

è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæœ¬é¡¹ç›®é‡‡ç”¨ **PN-CDQN** è€Œä¸æ˜¯æ™®é€š DQN + ç¯å¢ƒä¿®æ­£çš„åŸå› ï¼

---

### ä¸‰å¤§æŠ€æœ¯çš„ååŒå·¥ä½œ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. SE-MDP: çŠ¶æ€å¢å¼º                                     â”‚
â”‚     è§‚æµ‹ = (å¤–éƒ¨è§‚å¯Ÿ, Petriç½‘å†…éƒ¨çŠ¶æ€)                    â”‚
â”‚     â†“                                                    â”‚
â”‚  2. PN-CDQN: æ™ºèƒ½ä½“å±‚çº¦æŸ                                â”‚
â”‚     åªåœ¨åˆæ³•åŠ¨ä½œä¸­é€‰æ‹©æœ€ä¼˜åŠ¨ä½œ                           â”‚
â”‚     â†“                                                    â”‚
â”‚  3. å®‰å…¨åŒ…è£…å™¨: ç¯å¢ƒå±‚æœ€åä¸€é“é˜²çº¿                        â”‚
â”‚     æ‹¦æˆªä»»ä½•æ¼ç½‘çš„éæ³•åŠ¨ä½œ                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¸‰å±‚é˜²æŠ¤æœºåˆ¶**ï¼š
1. **ç¬¬ä¸€å±‚ï¼ˆSE-MDPï¼‰**ï¼šçŠ¶æ€åŒ…å«çº¦æŸä¿¡æ¯ï¼Œæ™ºèƒ½ä½“çŸ¥é“å“ªäº›åŠ¨ä½œå¯ç”¨
2. **ç¬¬äºŒå±‚ï¼ˆPN-CDQNï¼‰**ï¼šæ™ºèƒ½ä½“ä¸»åŠ¨è¿‡æ»¤éæ³•åŠ¨ä½œï¼Œåªåœ¨åˆæ³•åŠ¨ä½œä¸­é€‰æ‹©
3. **ç¬¬ä¸‰å±‚ï¼ˆå®‰å…¨åŒ…è£…å™¨ï¼‰**ï¼šç¯å¢ƒä½œä¸ºæœ€åé˜²çº¿ï¼Œç¡®ä¿ä»»ä½•éæ³•åŠ¨ä½œéƒ½ä¸ä¼šè¢«æ‰§è¡Œ

è¿™ç§**ä¸‰å±‚é˜²æŠ¤**è®¾è®¡ç¡®ä¿äº†ç³»ç»Ÿçš„å®‰å…¨æ€§å’Œå¯é æ€§ï¼

## ğŸ” æ ¸å¿ƒæ¦‚å¿µè¯¦è§£

### Petri ç½‘åœ¨äº¤é€šæ§åˆ¶ä¸­çš„ä½œç”¨

Petri ç½‘ç”¨äºå»ºæ¨¡äº¤é€šè·¯å£çš„**ä¿¡å·ç¯çŠ¶æ€è½¬æ¢è§„åˆ™**ï¼š

- **åº“æ‰€ (Place)**: è¡¨ç¤ºä¿¡å·ç¯çš„çŠ¶æ€ï¼ˆå¦‚ "GreenSN" è¡¨ç¤ºå—åŒ—æ–¹å‘ç»¿ç¯ï¼‰
- **å˜è¿ (Transition)**: è¡¨ç¤ºä¿¡å·ç¯åˆ‡æ¢åŠ¨ä½œï¼ˆå¦‚ "RtoGwe" è¡¨ç¤ºä»çº¢ç¯åˆ‡æ¢åˆ°ä¸œè¥¿æ–¹å‘ç»¿ç¯ï¼‰
- **Token**: è¡¨ç¤ºå½“å‰æ¿€æ´»çš„çŠ¶æ€
- **çº¦æŸ**: é€šè¿‡ Petri ç½‘çš„ç»“æ„ç¡®ä¿æŸäº›ä¿¡å·ç¯ç»„åˆä¸èƒ½åŒæ—¶å‡ºç°ï¼ˆä¿è¯å®‰å…¨ï¼‰

### å¼ºåŒ–å­¦ä¹ ç¯å¢ƒ

`JunctionPetriNetEnv` æ˜¯ä¸€ä¸ªæ ‡å‡†çš„ Gymnasium ç¯å¢ƒï¼š

**è§‚æµ‹ç©ºé—´ (Observation Space)**:
- Petri ç½‘å˜è¿å¯ç”¨æ€§ï¼ˆå“ªäº›ä¿¡å·ç¯åˆ‡æ¢åŠ¨ä½œå½“å‰å¯ç”¨ï¼‰
- å„è½¦é“è½¦è¾†æ•°é‡
- å„è½¦é“æœ€é•¿ç­‰å¾…æ—¶é—´

**åŠ¨ä½œç©ºé—´ (Action Space)**:
- ç¦»æ•£åŠ¨ä½œï¼šæ¯ä¸ªåŠ¨ä½œå¯¹åº”ä¸€ä¸ª Petri ç½‘å˜è¿ï¼ˆä¿¡å·ç¯åˆ‡æ¢ï¼‰æˆ–"ä¸æ“ä½œ"

**å¥–åŠ±å‡½æ•°**:
- åŠ¨ä½œæˆåŠŸå¥–åŠ±
- é€šè¡Œè½¦è¾†æ•°å¥–åŠ±
- ç­‰å¾…æ—¶é—´æƒ©ç½š
- æ—¶é—´æ­¥æƒ©ç½š

**ç»ˆæ­¢æ¡ä»¶**:
- æŸè½¦é“è½¦è¾†æ•°è¶…è¿‡é˜ˆå€¼
- è¾¾åˆ°æœ€å¤§æ­¥æ•°

### çº¦æŸæ„ŸçŸ¥ DQN (CDQN)

CDQN æ˜¯æœ¬é¡¹ç›®å®ç°çš„ **PN-CDQNï¼ˆPetri ç½‘çº¦æŸçš„ DQNï¼‰** çš„æ ¸å¿ƒç®—æ³•ã€‚è¯¦ç»†å®ç°åŸç†å’Œä»£ç ä½ç½®è¯·å‚è€ƒä¸Šæ–¹çš„ **[å…³é”®æŠ€æœ¯ 2ï¼šPN-CDQN](#å…³é”®æŠ€æœ¯-2pn-cdqnpetri-ç½‘çº¦æŸçš„-dqn)** éƒ¨åˆ†ã€‚

**æ ¸å¿ƒæ€æƒ³æ€»ç»“**ï¼š
- åœ¨åŠ¨ä½œé€‰æ‹©æ—¶ï¼Œåªä» Petri ç½‘å…è®¸çš„åˆæ³•åŠ¨ä½œä¸­é€‰æ‹©æœ€ä¼˜åŠ¨ä½œ
- åœ¨ Q å€¼æ›´æ–°æ—¶ï¼Œåªè€ƒè™‘åˆæ³•åŠ¨ä½œçš„ Q å€¼
- ç¡®ä¿æ™ºèƒ½ä½“æ°¸è¿œä¸ä¼šè¿å Petri ç½‘çº¦æŸ

**å…³é”®ä»£ç ä½ç½®**ï¼š
- `agents/constrained_dqn.py`ï¼šCDQN æ™ºèƒ½ä½“å®ç°
- `agents/constrained_model.py`ï¼šçº¦æŸæ„ŸçŸ¥çš„æ¨¡å‹å±‚

## ğŸ“Š è¯„ä¼°æŒ‡æ ‡

ç³»ç»Ÿæ”¯æŒä»¥ä¸‹è¯„ä¼°æŒ‡æ ‡ï¼š

- **æ€»æ­¥æ•° (Total Timesteps)**: å®Œæˆä¸€æ¬¡ä»¿çœŸçš„æ€»æ­¥æ•°
- **çº¦æŸè¿åæ¬¡æ•° (Constraints Broken)**: è¿å Petri ç½‘çº¦æŸçš„æ¬¡æ•°
- **å¹³å‡ç­‰å¾…æ—¶é—´ (Average Waiting Time)**: è½¦è¾†çš„å¹³å‡ç­‰å¾…æ—¶é—´
- **æœ€å°/æœ€å¤§ç­‰å¾…æ—¶é—´**: è½¦è¾†ç­‰å¾…æ—¶é—´çš„æå€¼
- **é€šè¡Œè½¦è¾†æ•°**: æˆåŠŸé€šè¿‡è·¯å£çš„è½¦è¾†æ€»æ•°

## ğŸ“ å­¦ä¹ è·¯å¾„å»ºè®®

å¦‚æœä½ æ˜¯åˆå­¦è€…ï¼Œå»ºè®®æŒ‰ä»¥ä¸‹é¡ºåºç†è§£é¡¹ç›®ï¼š

1. **è¿è¡ŒåŸºçº¿è„šæœ¬** (`baseline.py`)
   - ç†è§£ç¯å¢ƒçš„åŸºæœ¬äº¤äº’æµç¨‹
   - è§‚å¯Ÿè§‚æµ‹ã€å¥–åŠ±ã€ä¿¡æ¯ç­‰è¿”å›å€¼

2. **é˜…è¯»ç¯å¢ƒä»£ç ** (`environment/petri_net.py`)
   - ç†è§£ `step()` æ–¹æ³•çš„å®Œæ•´æµç¨‹
   - ç†è§£è½¦è¾†åˆ°è¾¾/ç¦»å¼€çš„ä»¿çœŸé€»è¾‘
   - ç†è§£ Petri ç½‘å¦‚ä½•çº¦æŸåŠ¨ä½œç©ºé—´

3. **ç†è§£ Petri ç½‘è§£æ** (`utils/petri_net/`)
   - äº†è§£ PNPRO æ–‡ä»¶å¦‚ä½•è¢«è§£æ
   - ç†è§£ Placeã€Transitionã€Arc çš„å«ä¹‰

4. **å­¦ä¹ æ™ºèƒ½ä½“** (`agents/`)
   - ç†è§£ DQN çš„åŸºæœ¬ç»“æ„
   - é‡ç‚¹ç†è§£ CDQN å¦‚ä½•åˆ©ç”¨çº¦æŸ

5. **è¿è¡Œè®­ç»ƒè„šæœ¬** (`train.py`)
   - ç†è§£å®Œæ•´çš„è®­ç»ƒæµç¨‹
   - è§‚å¯Ÿè®­ç»ƒæ—¥å¿—å’Œ TensorBoard è¾“å‡º

## ğŸ”§ è‡ªå®šä¹‰é…ç½®

### ä¿®æ”¹å¥–åŠ±å‡½æ•°

åœ¨ `rewards/__init__.py` ä¸­æ·»åŠ è‡ªå®šä¹‰å¥–åŠ±å‡½æ•°ï¼š

```python
def my_custom_reward(prev_obs, obs, success, timestep, waiting_times) -> float:
    # ä½ çš„å¥–åŠ±è®¡ç®—é€»è¾‘
    reward = 0
    if success:
        reward += 100
    # ... æ›´å¤šè®¡ç®—
    return reward
```

ç„¶ååœ¨åˆ›å»ºç¯å¢ƒæ—¶ä½¿ç”¨ï¼š
```python
env = JunctionPetriNetEnv(reward_function=my_custom_reward, ...)
```

### ä¿®æ”¹ç½‘ç»œç»“æ„

åœ¨ `agents/dqn.py` ä¸­ä¿®æ”¹ `get_dqn_model()` å‡½æ•°çš„ç½‘ç»œé…ç½®ï¼š

```python
hiddens=[128, 128, 64],  # ä¿®æ”¹éšè—å±‚å¤§å°
hidden_activation=["relu", "relu", "tanh"],  # ä¿®æ”¹æ¿€æ´»å‡½æ•°
```

### ä¿®æ”¹äº¤é€šåœºæ™¯

æ›¿æ¢ `data/traffic-scenario.PNPRO` æ–‡ä»¶ï¼Œæˆ–ä½¿ç”¨ PNML æ ¼å¼ï¼š

```python
net = get_petri_net('data/my-scenario.PNML', type=Parser.PNML)
```

## ğŸ“ˆ å®éªŒç»“æœ

è®­ç»ƒå®Œæˆåï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼æŸ¥çœ‹ç»“æœï¼š

1. **TensorBoard**: è®­ç»ƒè¿‡ç¨‹ä¸­çš„æŸå¤±ã€å¥–åŠ±ç­‰æŒ‡æ ‡
2. **CSV æ–‡ä»¶**: `simulation.py` ç”Ÿæˆçš„æ‰¹é‡è¯„ä¼°ç»“æœ
3. **å¯è§†åŒ–**: ä½¿ç”¨ `plotting/` ç›®å½•ä¸­çš„è„šæœ¬ç”Ÿæˆå›¾è¡¨

### GAIL ä¸ Baseline å¯è§†åŒ–å¯¹æ¯”

- **ç»Ÿä¸€å…¥å£**ï¼šæ‰€æœ‰å¯è§†åŒ–ï¼ˆBaseline V1/V2ã€CDQNã€DQNã€GAILï¼‰éƒ½é€šè¿‡ `visual.py` å®Œæˆã€‚
- **ä¸€é”®å¯¹æ¯”**ï¼šè¿è¡Œ `bash compare_visual.sh [æ­¥æ•°]`ï¼ˆé»˜è®¤ 50 æ­¥ï¼‰ä¼šç”Ÿæˆ B1ã€B2ã€GAIL çš„å¸§å¹¶åˆæˆ `B1.mp4`ã€`B2.mp4`ã€`GAIL.mp4`ï¼Œä¸‹è½½åˆ°æœ¬åœ°å³å¯å¯¹æ¯”è§‚çœ‹ã€‚
- **å‰ç½®**ï¼šGAIL è§†é¢‘éœ€è¦å…ˆè®­ç»ƒæ¨¡ä»¿å­¦ä¹ ç­–ç•¥ï¼š`python gail.py`ï¼Œå¾—åˆ° `gail_policy.pt` åå†è¿è¡Œå¯¹æ¯”è„šæœ¬ã€‚
- **æ‰‹åŠ¨å¯¹æ¯”**ï¼šä¹Ÿå¯åˆ†åˆ«è¿è¡Œ `python visual.py --mode baseline --baseline-version v1 --render frames --out frames_b1 --steps 50` ä¸ `python visual.py --mode imitation --path gail_policy.pt --render frames --out frames_gail --steps 50`ï¼Œå†ç”¨ ffmpeg åˆæˆè§†é¢‘ã€‚

## ğŸ¤ è´¡çŒ®æŒ‡å—

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼

## ğŸ“ è®¸å¯è¯

MIT License

## ğŸ™ è‡´è°¢

- [skrl](https://github.com/Toni-SM/skrl): å¼ºåŒ–å­¦ä¹ ç®—æ³•åº“
- [snakes](https://github.com/fpom/snakes): Petri ç½‘åº“
- [Gymnasium](https://github.com/Farama-Foundation/Gymnasium): å¼ºåŒ–å­¦ä¹ ç¯å¢ƒæ ‡å‡†

## ğŸ“§ è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·æäº¤ Issueã€‚

---

**æ³¨æ„**: æœ¬é¡¹ç›®ä¸»è¦ç”¨äºç ”ç©¶å’Œæ•™è‚²ç›®çš„ã€‚åœ¨å®é™…äº¤é€šç³»ç»Ÿä¸­åº”ç”¨å‰ï¼Œè¯·è¿›è¡Œå……åˆ†çš„æµ‹è¯•å’ŒéªŒè¯ã€‚
